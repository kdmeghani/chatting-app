{% extends "base.html" %}
{% block title %}Register{% endblock %}
{% block content %}
<div class="auth-form">
    <h2>Register</h2>
    <form id="registerForm">
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
        <div>
            <label>Username:</label>
            <input type="text" name="username" required>
        </div>
        <div>
            <label>Email:</label>
            <input type="email" name="email" required>
        </div>
        <div>
            <label>Password:</label>
            <input type="password" name="password" required>
        </div>
        <button type="submit">Register</button>
    </form>
    <p>Already have an account? <a href="{{ url_for('login') }}">Login</a></p>
</div>
<script>
    // Generate RSA keys and encrypt private key with password
    document.getElementById('registerForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const form = e.target;
        const username = form.username.value;
        const email = form.email.value;
        const password = form.password.value;

        // Generate RSA key pair
        const keyPair = await crypto.subtle.generateKey(
            {
                name: "RSA-OAEP",
                modulusLength: 2048,
                publicExponent: new Uint8Array([1, 0, 1]),
                hash: "SHA-256",
            },
            true,
            ["encrypt", "decrypt"]
        );

        // Export public key as PEM
        const publicKeySpki = await crypto.subtle.exportKey("spki", keyPair.publicKey);
        const publicKeyPem = "-----BEGIN PUBLIC KEY-----\n" + btoa(String.fromCharCode(...new Uint8Array(publicKeySpki))) + "\n-----END PUBLIC KEY-----";

        // Export private key as PKCS8
        const privateKeyPkcs8 = await crypto.subtle.exportKey("pkcs8", keyPair.privateKey);
        const privateKeyBase64 = btoa(String.fromCharCode(...new Uint8Array(privateKeyPkcs8)));

        // Derive key from password using PBKDF2
        const passwordKey = await crypto.subtle.importKey(
            "raw",
            new TextEncoder().encode(password),
            { name: "PBKDF2" },
            false,
            ["deriveBits", "deriveKey"]
        );

        const salt = crypto.getRandomValues(new Uint8Array(16));
        const derivedKey = await crypto.subtle.deriveKey(
            {
                name: "PBKDF2",
                salt: salt,
                iterations: 100000,
                hash: "SHA-256"
            },
            passwordKey,
            { name: "AES-GCM", length: 256 },
            true,
            ["encrypt", "decrypt"]
        );

        // Encrypt private key with AES-GCM
        const iv = crypto.getRandomValues(new Uint8Array(12));
        const encryptedPrivateKey = await crypto.subtle.encrypt(
            { name: "AES-GCM", iv: iv },
            derivedKey,
            new TextEncoder().encode(privateKeyBase64)
        );

        // Combine salt + iv + ciphertext
        const encryptedPrivateKeyData = new Uint8Array(salt.length + iv.length + encryptedPrivateKey.byteLength);
        encryptedPrivateKeyData.set(salt, 0);
        encryptedPrivateKeyData.set(iv, salt.length);
        encryptedPrivateKeyData.set(new Uint8Array(encryptedPrivateKey), salt.length + iv.length);
        const encryptedPrivateKeyBase64 = btoa(String.fromCharCode(...encryptedPrivateKeyData));

        // Send to server
        const formData = new FormData();
        formData.append('username', username);
        formData.append('email', email);
        formData.append('password', password);
        formData.append('public_key', publicKeyPem);
        formData.append('encrypted_private_key', encryptedPrivateKeyBase64);
        formData.append('csrf_token', form.csrf_token.value);

        const response = await fetch('/register', {
            method: 'POST',
            body: formData
        });
        if (response.redirected) {
            window.location.href = response.url;
        } else {
            alert('Registration failed');
        }
    });
</script>
{% endblock %}